From a879156e52861e801424f7be43cd9309f8b8e9a7 Mon Sep 17 00:00:00 2001
From: Jorrit Schippers <jorrit@161217.no-reply.drupal.org>
Date: Sun, 28 Apr 2013 17:37:55 +0200
Subject: [PATCH] Issue #1970064 by Jorrit: Fixed notice 'Undefined index:
 instance in DrupalTextMetaTag->getValue()'

---
 metatag_panels/metatag_panels.module |   19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/metatag_panels/metatag_panels.module b/metatag_panels/metatag_panels.module
index 4d6b891..b6986b9 100644
--- a/metatag_panels/metatag_panels.module
+++ b/metatag_panels/metatag_panels.module
@@ -94,6 +94,13 @@ function metatag_panels_ctools_render_alter($info, $page, $context) {
     return;
   }
 
+  $metatags = $handler->conf['metatag_panels']['metatags'];
+  $metatags += metatag_config_load_with_defaults('');
+
+  if (empty($metatags)) {
+    return;
+  }
+
   // Get the contexts that exist within this panel.
   ctools_include('context-task-handler');
   $task_object = ctools_context_handler_get_task_object($context['task'], $context['subtask'], $context['handler']);
@@ -106,20 +113,20 @@ function metatag_panels_ctools_render_alter($info, $page, $context) {
   }
 
   // Build the Metatag.
-  $metatags = $handler->conf['metatag_panels']['metatags'];
-  $metatags += metatag_config_load_with_defaults('');
-
+  $options = array(
+    'instance' => 'panels:' . $handler->name,
+    'token data' => $tokens,
+  );
   foreach ($metatags as $metatag => $data) {
     $metatag_instance = metatag_get_instance($metatag, $data);
 
     if ($metatag_instance) {
-      $output[$metatag] = $metatag_instance->getElement(array('token data' => $tokens));
+      $output[$metatag] = $metatag_instance->getElement($options);
     }
   }
 
   // Give third-parties the opportunity to alter the metatag for a given instance.
-  $instance = 'panels:' . $handler->name;
-  drupal_alter('metatag_metatags_view', $output, $instance);
+  drupal_alter('metatag_metatags_view', $output, $options['instance']);
 }
 
 /**
-- 
1.7.10.4

